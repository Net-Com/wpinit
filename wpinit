#!/bin/bash
if [ ! -f wp-cli.phar ]; then
	echo "download wp-cli"
	echo "--------------------------------------------------------"
    curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar 
    echo "--------------------------------------------------------"
    echo "wp-cli installed"
fi

min=10000
max=99999
number=$[($RANDOM % ($[$max - $min] + 1)) + $min]
tmpfile=/tmp/wpinit${number}.log
adminpassword=$(openssl rand -base64 8)
adminloginsuffix=$[($RANDOM % ($[$max - $min] + 1)) + $min]
clientadminpassword=$(openssl rand -base64 8)
clienteditorpassword=$(openssl rand -base64 8)

echo $adminpassword

echo $number

echo $tmpfile

rm $tmpfile
touch $tmpfile

clear

echo "installation wordpress"
php wp-cli.phar core download --locale=fr_FR

echo 'db information'
read -p 'db name : ' dbname
read -p 'db user : ' dbuser
read -p 'db password : ' dbpassword

echo "db" >> $tmpfile
echo "----------------------------" >> $tmpfile
echo "dbname : $dbname" >> $tmpfile
echo "dbuser : $dbuser" >> $tmpfile
echo "dbpass : $dbpassword" >> $tmpfile
echo "dbprefix : wp${number}_" >> $tmpfile
echo "----------------------------"

php wp-cli.phar config create --dbname=$dbname --dbuser=$dbuser --dbpass=$dbpassword --dbprefix=wp${number}_ --locale=fr_FR
php wp-cli.phar db reset

echo 'site information'
read -p 'url : ' url
read -p 'title : ' title
read -p 'admin login : ' adminlogin
read -p 'admin email : ' adminemail

echo "site" >> $tmpfile
echo "----------------------------" >> $tmpfile
echo "url : $url" >> $tmpfile
echo "title : $title" >> $tmpfile
echo "admin login : ${adminlogin}_${adminloginsuffix}" >> $tmpfile
echo "admin email : $adminemail" >> $tmpfile
echo "admin password : $adminpassword" >> $tmpfile
echo "admin url : ${url}/wp-admin" >> $tmpfile
echo "----------------------------"

php wp-cli.phar core install --url="$url" --title="$title" --admin_user="${adminlogin}_${adminloginsuffix}" --admin_password="$adminpassword" --admin_email="$adminemail"

echo "client admin"
read -p 'client admin login : ' clientadminlogin
read -p 'client admin email : ' clientadminemail

echo "client admin" >> $tmpfile
echo "----------------------------" >> $tmpfile
echo "client admin login : $clientadminlogin" >> $tmpfile
echo "client admin email : $clientadminemail" >> $tmpfile
echo "client admin password : $clientadminpassword" >> $tmpfile
echo "----------------------------" >> $tmpfile

php wp-cli.phar user create "${clientadminlogin}" "${clientadminemail}" --role=administrator --user_pass="${clientadminpassword}"

echo "client editor"
read -p 'client editor login : ' clienteditorlogin
read -p 'client editor email : ' clienteditoremail

echo "client editor" >> $tmpfile
echo "----------------------------" >> $tmpfile
echo "client editor login : $clienteditorlogin" >> $tmpfile
echo "client editor email : $clienteditoremail" >> $tmpfile
echo "client editor password : $clienteditorpassword" >> $tmpfile
echo "----------------------------" >> $tmpfile

php wp-cli.phar user create "${clienteditorlogin}" "${clienteditoremail}" --role=editor --user_pass="${clienteditorpassword}"

echo "define permalink"
php wp-cli.phar rewrite structure '/%postname%/'

echo "regenerate permalink"
php wp-cli.phar rewrite flush

echo "clean default wordpress install"
php wp-cli.phar plugin delete hello
php wp-cli.phar plugin delete akismet
php wp-cli.phar plugin delete hello-dolly
php wp-cli.phar post delete 1

php wp-cli.phar option list --autoload=on
php wp-cli.phar option update blogdescription ''
php wp-cli.phar option update use_smilies 0
php wp-cli.phar option update blog_public 0

cd wp-content/themes
git clone https://cgreg21@bitbucket.org/cgreg21/genesis.git
git clone https://github.com/cgreg21/wp-base-theme.git

cat $tmpfile

mail -s "detail ${url}" ${adminemail} < $tmpfile
#rm $tmpfile